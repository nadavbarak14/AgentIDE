# Implementation Plan: IDE Panels (v2 — Clarification Update)

**Branch**: `002-ide-panels` | **Date**: 2026-02-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-ide-panels/spec.md` (post-clarification)

## Summary

Transform the single-session terminal view into an IDE-like workspace with three contextual side panels: **File Explorer** (tree + editor side-by-side), **Git Changes** (side-by-side two-column diff with gutter "+" commenting), and **Web Preview** (iframe). Panel state persists per session via SQLite. Only active in 1-view mode.

This is a **v2 update** to the existing implementation. The v1 code is already committed. The following changes are required based on user clarifications:

1. **DiffViewer**: Rewrite from unified diff to **side-by-side two-column** layout (old left, new right, line-aligned). Add **"+" gutter icon** for inline comments instead of select-then-click.
2. **Files panel**: Change from tree-replaces-editor to **tree + editor side-by-side** (tree always visible on left, editor on right within the panel).
3. **Diff parser**: Rewrite `parseDiff()` to produce paired left/right line arrays for side-by-side rendering.

## Technical Context

**Language/Version**: TypeScript 5.7, Node.js 20 LTS
**Primary Dependencies**: React 18, Tailwind CSS 3, Monaco Editor (@monaco-editor/react 4.6), xterm.js 5, Express 4, ws, chokidar, diff2html, better-sqlite3
**Storage**: SQLite (better-sqlite3) with WAL mode
**Testing**: Vitest 2.1 (unit + integration)
**Target Platform**: Linux server (single-machine deployment)
**Project Type**: Web application (backend + frontend npm workspaces)
**Performance Goals**: File open <2s, diff render <3s for 500 modified lines, panel state restore instant
**Constraints**: Side-by-side diff must align old/new lines vertically; "+" icon must be discoverable
**Scale/Scope**: Single developer, 1-10 concurrent sessions

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Comprehensive Testing | PASS | Existing 90 tests cover panel state + comments. New tests needed for side-by-side diff parser and tree+editor layout |
| II. UX-First Design | PASS | Clarifications directly address UX (side-by-side diff, tree+editor, gutter "+") |
| III. UI Quality & Consistency | PASS | Side-by-side diff with green/red highlights follows standard code review patterns |
| IV. Simplicity | PASS | Changes are focused on 3 frontend components, no new abstractions |
| V. CI/CD Pipeline | PASS | Work on feature branch, PR to main with rebase merge |
| VI. Frontend Plugin Quality | PASS | No new plugins needed — Monaco and existing deps sufficient |
| VII. Backend Security | PASS | No backend changes in this update — only frontend rendering |
| VIII. Observability & Logging | PASS | No new logging needed — existing infrastructure covers API calls |

## Project Structure

### Documentation (this feature)

```text
specs/002-ide-panels/
├── plan.md              # This file (v2 update)
├── research.md          # Phase 0 output (updated with R9)
├── data-model.md        # Unchanged from v1
├── quickstart.md        # Updated with v2 changes
├── contracts/api.md     # Unchanged from v1
└── tasks.md             # Will be regenerated by /speckit.tasks
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/          # db.ts, types.ts, repository.ts — UNCHANGED
│   ├── services/        # session-manager.ts — UNCHANGED
│   ├── api/routes/      # sessions.ts — UNCHANGED
│   └── worker/          # git-operations.ts — UNCHANGED
└── tests/               # Existing tests remain valid

frontend/
├── src/
│   ├── components/
│   │   ├── SessionCard.tsx   # MODIFY: files panel layout (tree + editor side-by-side)
│   │   ├── DiffViewer.tsx    # REWRITE: side-by-side two-column diff + gutter "+" comments
│   │   ├── FileTree.tsx      # UNCHANGED
│   │   ├── FileViewer.tsx    # UNCHANGED (but now rendered alongside FileTree)
│   │   ├── LivePreview.tsx   # UNCHANGED
│   │   ├── SessionGrid.tsx   # UNCHANGED
│   │   └── TerminalView.tsx  # UNCHANGED
│   ├── hooks/
│   │   └── usePanel.ts       # UNCHANGED
│   └── services/
│       └── api.ts            # UNCHANGED
└── tests/
    └── unit/
        └── api.test.ts       # Add tests for side-by-side diff parser
```

**Structure Decision**: Existing web application structure (backend + frontend workspaces). No structural changes needed for v2.

## Changes Required (v2 Delta)

### Change 1: Side-by-Side Diff Rendering (DiffViewer.tsx)

**Current**: Unified diff — single column, lines prefixed with +/-, green/red highlighting.

**Target**: Two-column layout — old file on left, new file on right, aligned by line number. Context lines appear in both columns. Added lines appear only in the right column (green). Deleted lines appear only in the left column (red). Empty placeholder rows maintain alignment.

**Implementation approach**:
- Rewrite `parseDiff()` to produce `SideBySideLine[]` pairs: `{ left: DiffLine | null, right: DiffLine | null }`
- For context lines: both left and right populated with same content, different line numbers
- For added lines: left is null (empty placeholder), right has the added content
- For deleted lines: left has the deleted content, right is null (empty placeholder)
- Render as a table/grid with two columns, each showing line number + content
- Each column has its own gutter with "+" icon for commenting

### Change 2: Gutter "+" Comment Icon (DiffViewer.tsx)

**Current**: Click line number in gutter → line selected → "Comment" button appears at bottom → click to open text input.

**Target**: Each line in the right column gutter has a "+" icon (visible on hover). Clicking "+" immediately opens an inline comment box below that row. Shift-click extends to a range. No intermediate "Comment" button needed.

**Implementation approach**:
- Add a "+" icon element in each gutter cell, visible on `:hover`
- On click: immediately show inline comment textarea below the clicked row
- On shift-click: extend selection range, comment box moves to end of range
- Remove the separate "Comment" button that currently appears after selection

### Change 3: Files Panel Tree+Editor Layout (SessionCard.tsx)

**Current**: When files panel is open, if no tabs → show FileTree; if tabs exist → show FileViewer (tree disappears).

**Target**: When files panel is open, always show both: FileTree on left (~30% width), FileViewer on right (~70% width). If no file is selected, right side shows "Select a file to view" placeholder.

**Implementation approach**:
- In SessionCard's files panel section, render `FileTree` and `FileViewer` side-by-side within a flex container
- FileTree gets a fixed narrow width (~200px or 30% of panel)
- FileViewer takes remaining space
- When no file tabs exist, show a placeholder in the editor area
- Remove the current conditional that swaps between tree and viewer

## Complexity Tracking

No violations. All changes are focused frontend rendering updates within existing components.
