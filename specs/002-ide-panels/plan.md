# Implementation Plan: IDE Panels v7 — Real-Time Git Diff + Ephemeral Comments

**Branch**: `002-ide-panels` | **Date**: 2026-02-18 | **Spec**: `specs/002-ide-panels/spec.md`
**Input**: v7 clarifications — real-time Git diff auto-refresh (FR-030), ephemeral comments (FR-009/FR-010 updated)

## Summary

Two changes in v7:
1. **Real-time Git diff refresh**: The DiffViewer currently shows a "Loading diff..." spinner every time `refreshKey` changes (file watcher event). Fix: fetch new diff in the background and swap data in-place, preserving selected file, scroll position, and pending comments. Same responsiveness as the Files panel.
2. **Ephemeral comments**: After "Send All" delivers comments to Claude, clear them from the diff view entirely. No "Sent" badges, no comment history. Comments exist only as transient feedback. Also clean up: delete delivered comments from the backend database after delivery.

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js 20 LTS
**Primary Dependencies**: React 18, Tailwind CSS 3, Express, SQLite (better-sqlite3)
**Storage**: SQLite (comments table already exists)
**Testing**: Vitest 2.1 (92 backend + 27 frontend tests)
**Target Platform**: Linux server, modern browser
**Project Type**: Web application (monorepo: backend/ + frontend/)
**Constraints**: All changes frontend-only except comment cleanup on deliver

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| # | Principle | Status | Notes |
|---|-----------|--------|-------|
| I | Comprehensive Testing | PASS | Will add tests for background refresh behavior and ephemeral comment clearing |
| II | UX-First Design | PASS | Background refresh eliminates disruptive loading spinner; clearing sent comments reduces UI clutter |
| III | UI Quality & Consistency | PASS | Matches Files panel behavior (smooth background updates) |
| IV | Simplicity | PASS | Two targeted changes, no new abstractions |
| V | CI/CD Pipeline | PASS | Will verify tests + lint + build before commit |
| VI | Frontend Plugin Quality | PASS | No new dependencies |
| VII | Backend Security | PASS | Comment deletion uses existing safe patterns |
| VIII | Observability | PASS | Existing logging covers deliver + delete operations |

## Project Structure

### Documentation (this feature)

```text
specs/002-ide-panels/
├── plan.md              # This file (v7)
├── research.md          # R1-R24 (v1-v6) + R25-R26 (v7)
├── spec.md              # Updated with v7 clarifications
├── quickstart.md        # Updated for v7
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (files modified in v7)

```text
frontend/
├── src/
│   └── components/
│       └── DiffViewer.tsx     # Background refresh, ephemeral comment clearing
└── tests/
    └── unit/
        └── v7-features.test.ts  # Tests for v7 changes

backend/
├── src/
│   └── api/
│       └── routes/sessions.ts  # Delete comments after delivery
└── tests/
    └── integration/
        └── ide-panels.test.ts  # Update deliver test expectations
```

## Changes

### Change 1: Background Diff Refresh (FR-030)

**Problem**: When `refreshKey` changes (file watcher event), `DiffViewer` calls `setLoading(true)` → fetches diff → `setLoading(false)`. This flashes "Loading diff..." on every file change, disrupting the user's review.

**Solution**: Fetch the new diff without setting `loading = true`. Only show loading on initial load (when `diff` is null). On subsequent refreshes, fetch in the background and silently replace `diff` and `parsedFiles` state. The selected file, scroll position, and pending comments are preserved because they're separate state variables that aren't reset.

**Specific change in DiffViewer.tsx**:
- Split the load effect into initial load (shows spinner) vs. background refresh (silent)
- On refreshKey change when diff already exists: fetch without `setLoading(true)`
- Only show loading spinner when `diff === null` (first load or error)

### Change 2: Ephemeral Comments (FR-009, FR-010)

**Problem**: After "Send All" delivers comments, they remain in the diff view with "Sent" / "Pending" badges. The user wanted comments to be temporary feedback — once sent, they should disappear.

**Solution**: After `commentsApi.deliver()` succeeds in `handleSendAll`, clear `existingComments` that were delivered. On the backend, the deliver endpoint should delete comments from the database after marking them sent (they served their purpose).

**Frontend changes (DiffViewer.tsx)**:
- In `handleSendAll`: after deliver succeeds, remove delivered comments from `existingComments` state
- Remove the "Pending"/"Sent" badge rendering — comments only show while pending (yellow indicator), then vanish after send

**Backend changes (sessions.ts)**:
- In `POST /comments/deliver`: after successfully injecting and marking comments as sent, delete them from the database. They're ephemeral.
- Add `deleteComment(id)` to repository if not present, or use existing delete functionality.

## Complexity Tracking

No violations. Both changes are simple, targeted modifications to existing code.
