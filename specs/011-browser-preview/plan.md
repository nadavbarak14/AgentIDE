# Implementation Plan: Preview Visual Feedback & Media

**Branch**: `011-browser-preview` | **Date**: 2026-02-20 | **Spec**: `specs/011-browser-preview/spec.md`
**Input**: Feature specification from `/specs/011-browser-preview/spec.md`

## Summary

Add visual feedback and media capabilities to the existing preview browser: element inspection with comments, image upload, custom viewport resolution, screenshot capture with annotations, video recording, and agent browser control via `/view.*` skills. The agent gains autonomous browsing capabilities (navigate, click, type, read page) using the existing board command protocol with a new synchronous response pattern.

## Technical Context

**Language/Version**: TypeScript 5.7, Node.js 20 LTS
**Primary Dependencies**: React 18, Express 4, Tailwind CSS 3, Vite 6, html2canvas-pro@1.5.8, better-sqlite3, ws 8
**Storage**: SQLite (better-sqlite3) with WAL mode — existing `c3.db` database; 3 new tables (`preview_comments`, `uploaded_images`, `video_recordings`)
**Testing**: Vitest 2.1.0, @testing-library/react, supertest
**Target Platform**: Linux server (VPS), modern browsers (Chrome/Edge/Firefox)
**Project Type**: Web application (backend/ + frontend/)
**Performance Goals**: Screenshot capture < 3s, accessibility tree extraction < 1s, video recording at 3 FPS
**Constraints**: Bridge script must work in sandboxed iframe (`allow-scripts allow-same-origin`), skill scripts use `curl` (no WebSocket clients), max 5-minute video recording
**Scale/Scope**: Single-user sessions, ~10 concurrent preview comments, videos up to 5 minutes

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Comprehensive Testing | PASS | Unit tests for all new services/routes, system tests for bridge→skill round-trips |
| II. UX-First Design | PASS | 6 user stories with acceptance scenarios defined before implementation |
| III. UI Quality & Consistency | PASS | Overlay UI follows existing Tailwind dark theme, consistent with IDE chrome |
| IV. Simplicity | PASS | Custom canvas annotations instead of heavy library; accessibility tree via DOM walk instead of CDP; board command reuse instead of MCP |
| V. CI/CD Pipeline | PASS | All new code goes through existing CI pipeline |
| VI. Frontend Plugin Quality | PASS | html2canvas-pro (MIT, maintained fork); no rrweb needed (replaced with native MediaRecorder) |
| VII. Backend Security | PASS | Input validation on all new endpoints; multer file type/size limits; no secrets in responses |
| VIII. Observability & Logging | PASS | Structured logging for comment delivery, image upload, recording lifecycle, skill execution |

## Project Structure

### Documentation (this feature)

```text
specs/011-browser-preview/
├── plan.md              # This file
├── research.md          # Phase 0 output — 8 research items
├── data-model.md        # Phase 1 output — 3 new tables + type extensions
├── quickstart.md        # Phase 1 output — architecture overview + dev workflow
├── contracts/
│   └── api.md           # Phase 1 output — REST API contracts
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── api/
│   │   ├── routes/
│   │   │   ├── preview.ts          # Preview comments CRUD + delivery
│   │   │   └── uploads.ts          # Image upload with multer
│   │   └── inspect-bridge.js       # Bridge script (v4) — already implemented
│   ├── services/
│   │   └── preview-service.ts      # Comment delivery, image compression, recording storage
│   ├── models/
│   │   ├── types.ts                # Extended types (ViewportMode, BoardCommand, etc.)
│   │   └── repository.ts           # CRUD for new tables
│   └── hub-entry.ts                # Route registration, CSP, board command handler
└── tests/

frontend/
├── src/
│   ├── components/
│   │   ├── LivePreview.tsx          # Extended with custom viewport + overlay integration
│   │   ├── PreviewOverlay.tsx       # Comment pins, inspect mode UI, screenshot/record toolbar
│   │   ├── AnnotationCanvas.tsx     # Screenshot annotation drawing tools
│   │   ├── ImageUpload.tsx          # Drag-and-drop + file picker
│   │   └── RecordingPlayer.tsx      # WebM video playback
│   ├── hooks/
│   │   └── usePreviewBridge.ts      # postMessage communication with bridge — already implemented
│   └── services/
│       └── api.ts                   # API functions for new endpoints
└── tests/

.claude-skills/skills/
├── view-screenshot/                 # /view.screenshot skill
├── view-record-start/               # /view.record-start skill
├── view-record-stop/                # /view.record-stop skill
├── view-set-resolution/             # /view.set-resolution skill
├── view-navigate/                   # /view.navigate skill
├── view-click/                      # /view.click skill
├── view-type/                       # /view.type skill
└── view-read-page/                  # /view.read-page skill
```

**Structure Decision**: Web application structure (backend/ + frontend/) — consistent with the existing ClaudeQueue project. All 8 `/view.*` skills follow the existing `.claude-skills/skills/<name>/` directory pattern.

## Complexity Tracking

> No constitution violations. All choices favor simplicity:
> - Custom canvas annotations instead of Fabric.js/Konva.js
> - DOM walk for accessibility tree instead of Chrome DevTools Protocol
> - MediaRecorder + canvas.captureStream() instead of rrweb
> - Board command protocol reuse instead of MCP/WebMCP
